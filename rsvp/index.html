<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1a1a2e">
  <title>RSVP Reader</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon192.png">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      padding: 16px;
      padding-top: env(safe-area-inset-top, 16px);
      padding-bottom: env(safe-area-inset-bottom, 16px);
      display: flex;
      flex-direction: column;
    }
    
    h1 {
      font-size: 20px;
      margin-bottom: 12px;
      color: #fff;
      text-align: center;
      flex-shrink: 0;
    }
    
    /* Input View */
    .input-view {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }
    
    .input-view.hidden {
      display: none;
    }
    
    .text-input {
      flex: 1;
      width: 100%;
      padding: 12px;
      border: 2px solid #333;
      border-radius: 8px;
      background: #16213e;
      color: #fff;
      font-size: 16px;
      resize: none;
      outline: none;
      min-height: 150px;
    }
    
    .text-input:focus {
      border-color: #4a90d9;
    }
    
    .text-input::placeholder {
      color: #666;
    }
    
    .start-btn {
      width: 100%;
      padding: 14px;
      margin-top: 12px;
      background: #4a90d9;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    .start-btn:active {
      background: #357abd;
    }
    
    .start-btn:disabled {
      background: #333;
    }
    
    /* Reader View */
    .reader-view {
      display: none;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }
    
    .reader-view.active {
      display: flex;
    }
    
    .back-link {
      color: #4a90d9;
      font-size: 14px;
      margin-bottom: 8px;
      cursor: pointer;
      flex-shrink: 0;
    }
    
    /* RSVP Display */
    .rsvp-display {
      background: #0f0f23;
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      flex: 1;
      min-height: 120px;
    }
    
    .word-container {
      font-size: min(10vw, 42px);
      font-weight: 500;
      font-family: 'Courier New', monospace;
      letter-spacing: 1px;
    }
    
    .word-container .before-orp {
      color: #888;
    }
    
    .word-container .orp {
      color: #ff6b6b;
    }
    
    .word-container .after-orp {
      color: #888;
    }
    
    .status-text {
      color: #666;
      font-size: 16px;
    }
    
    /* Controls */
    .controls {
      display: flex;
      gap: 8px;
      margin: 16px 0;
      flex-shrink: 0;
    }
    
    .control-btn {
      flex: 1;
      padding: 14px 8px;
      background: #2d3a4f;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    
    .control-btn:active {
      background: #3d4a5f;
    }
    
    .control-btn.playing {
      background: #c0392b;
    }
    
    /* Settings */
    .settings {
      background: #16213e;
      border-radius: 8px;
      padding: 12px;
      flex-shrink: 0;
    }
    
    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .setting-row:last-child {
      margin-bottom: 0;
    }
    
    .setting-label {
      font-size: 14px;
      color: #aaa;
    }
    
    .setting-value {
      font-size: 14px;
      color: #4a90d9;
      font-weight: 600;
      min-width: 70px;
      text-align: right;
    }
    
    .slider {
      width: 140px;
      height: 8px;
      -webkit-appearance: none;
      background: #333;
      border-radius: 4px;
      outline: none;
    }
    
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 22px;
      height: 22px;
      background: #4a90d9;
      border-radius: 50%;
      cursor: pointer;
    }
    
    /* Progress */
    .progress-bar {
      width: 100%;
      height: 6px;
      background: #333;
      border-radius: 3px;
      margin-top: 12px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: #4a90d9;
      width: 0%;
      transition: width 0.1s linear;
    }
    
    .progress-text {
      font-size: 12px;
      color: #666;
      margin-top: 6px;
      text-align: center;
    }
    
    /* Tap zones for play/pause */
    .tap-zone {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10;
    }
    
    .rsvp-display {
      position: relative;
    }
  </style>
</head>
<body>
  <h1>⚡ RSVP Reader</h1>
  
  <!-- Input View -->
  <div class="input-view" id="inputView">
    <textarea class="text-input" id="textInput" placeholder="Paste article text here..."></textarea>
    <button class="start-btn" id="startBtn">Start Reading</button>
  </div>
  
  <!-- Reader View -->
  <div class="reader-view" id="readerView">
    <div class="back-link" id="backLink">← Paste new text</div>
    
    <div class="rsvp-display" id="rsvpDisplay">
      <div class="tap-zone" id="tapZone"></div>
      <div class="status-text" id="statusText">Tap to play</div>
      <div class="word-container" id="wordContainer" style="display: none;"></div>
    </div>
    
    <div class="controls">
      <button class="control-btn" id="playPauseBtn">▶ Play</button>
      <button class="control-btn" id="backBtn">⏮ Back</button>
      <button class="control-btn" id="restartBtn">↺ Restart</button>
    </div>
    
    <div class="settings">
      <div class="setting-row">
        <span class="setting-label">Speed</span>
        <input type="range" class="slider" id="wpmSlider" min="100" max="800" value="300">
        <span class="setting-value" id="wpmValue">300 WPM</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="progress-text" id="progressText">0 / 0 words</div>
    </div>
  </div>
  
  <script>
    class RSVPReader {
      constructor() {
        this.words = [];
        this.currentIndex = 0;
        this.isPlaying = false;
        this.wpm = 300;
        this.intervalId = null;
        
        this.initElements();
        this.initEventListeners();
        this.loadSettings();
        this.checkForSharedText();
      }
      
      initElements() {
        this.inputView = document.getElementById('inputView');
        this.readerView = document.getElementById('readerView');
        this.textInput = document.getElementById('textInput');
        this.startBtn = document.getElementById('startBtn');
        this.backLink = document.getElementById('backLink');
        this.statusText = document.getElementById('statusText');
        this.wordContainer = document.getElementById('wordContainer');
        this.playPauseBtn = document.getElementById('playPauseBtn');
        this.backBtn = document.getElementById('backBtn');
        this.restartBtn = document.getElementById('restartBtn');
        this.wpmSlider = document.getElementById('wpmSlider');
        this.wpmValue = document.getElementById('wpmValue');
        this.progressFill = document.getElementById('progressFill');
        this.progressText = document.getElementById('progressText');
        this.tapZone = document.getElementById('tapZone');
      }
      
      initEventListeners() {
        this.startBtn.addEventListener('click', () => this.startReading());
        this.backLink.addEventListener('click', () => this.showInputView());
        
        this.playPauseBtn.addEventListener('click', () => this.togglePlayPause());
        this.backBtn.addEventListener('click', () => this.goBack());
        this.restartBtn.addEventListener('click', () => this.restart());
        this.tapZone.addEventListener('click', () => this.togglePlayPause());
        
        this.wpmSlider.addEventListener('input', (e) => {
          this.wpm = parseInt(e.target.value, 10);
          this.wpmValue.textContent = `${this.wpm} WPM`;
          this.saveSettings();
          if (this.isPlaying) {
            this.stop();
            this.play();
          }
        });
        
        // Prevent zoom on double tap
        document.addEventListener('dblclick', (e) => e.preventDefault());
      }
      
      loadSettings() {
        const saved = localStorage.getItem('rsvp-wpm');
        if (saved) {
          this.wpm = parseInt(saved, 10);
          this.wpmSlider.value = this.wpm;
          this.wpmValue.textContent = `${this.wpm} WPM`;
        }
      }
      
      saveSettings() {
        localStorage.setItem('rsvp-wpm', this.wpm);
      }
      
      checkForSharedText() {
        // Check URL params for shared text (Web Share Target)
        const params = new URLSearchParams(window.location.search);
        const sharedText = params.get('text') || params.get('title') || '';
        const sharedUrl = params.get('url') || '';
        
        if (sharedText || sharedUrl) {
          this.textInput.value = sharedText + (sharedUrl ? '\n\n' + sharedUrl : '');
          // Clear the URL params
          window.history.replaceState({}, '', window.location.pathname);
        }
      }
      
      startReading() {
        const text = this.textInput.value.trim();
        if (!text) return;
        
        this.words = text.split(/\s+/).filter(w => w.length > 0);
        this.currentIndex = 0;
        
        if (this.words.length === 0) return;
        
        this.showReaderView();
        this.showWord(this.words[0]);
        this.updateProgress();
      }
      
      showInputView() {
        this.stop();
        this.inputView.classList.remove('hidden');
        this.readerView.classList.remove('active');
      }
      
      showReaderView() {
        this.inputView.classList.add('hidden');
        this.readerView.classList.add('active');
      }
      
      showWord(word) {
        this.statusText.style.display = 'none';
        this.wordContainer.style.display = 'block';
        
        const orpIndex = this.calculateORP(word);
        const before = word.substring(0, orpIndex);
        const orp = word.charAt(orpIndex);
        const after = word.substring(orpIndex + 1);
        
        this.wordContainer.innerHTML = 
          `<span class="before-orp">${this.escapeHtml(before)}</span>` +
          `<span class="orp">${this.escapeHtml(orp)}</span>` +
          `<span class="after-orp">${this.escapeHtml(after)}</span>`;
      }
      
      calculateORP(word) {
        const len = word.length;
        if (len <= 1) return 0;
        if (len <= 5) return 1;
        if (len <= 9) return 2;
        if (len <= 13) return 3;
        return 4;
      }
      
      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
      
      togglePlayPause() {
        if (this.isPlaying) {
          this.stop();
        } else {
          this.play();
        }
      }
      
      play() {
        if (this.words.length === 0) return;
        if (this.currentIndex >= this.words.length) {
          this.currentIndex = 0;
        }
        
        this.isPlaying = true;
        this.playPauseBtn.textContent = '⏸ Pause';
        this.playPauseBtn.classList.add('playing');
        
        const interval = 60000 / this.wpm;
        
        this.intervalId = setInterval(() => {
          this.showNextWord();
        }, interval);
      }
      
      stop() {
        this.isPlaying = false;
        this.playPauseBtn.textContent = '▶ Play';
        this.playPauseBtn.classList.remove('playing');
        
        if (this.intervalId) {
          clearInterval(this.intervalId);
          this.intervalId = null;
        }
      }
      
      showNextWord() {
        if (this.currentIndex >= this.words.length) {
          this.stop();
          this.statusText.textContent = 'Finished!';
          this.statusText.style.display = 'block';
          this.wordContainer.style.display = 'none';
          setTimeout(() => {
            if (this.words.length > 0) {
              this.showWord(this.words[this.words.length - 1]);
            }
          }, 1500);
          return;
        }
        
        const word = this.words[this.currentIndex];
        this.showWord(word);
        this.currentIndex++;
        this.updateProgress();
        
        // Pause on punctuation
        if (/[.!?]$/.test(word)) {
          this.stop();
          setTimeout(() => {
            if (this.currentIndex < this.words.length) {
              this.play();
            }
          }, 200);
        }
      }
      
      goBack() {
        const backAmount = Math.max(10, Math.floor(this.words.length * 0.05));
        this.currentIndex = Math.max(0, this.currentIndex - backAmount);
        if (this.words.length > 0) {
          this.showWord(this.words[Math.min(this.currentIndex, this.words.length - 1)]);
        }
        this.updateProgress();
      }
      
      restart() {
        this.stop();
        this.currentIndex = 0;
        if (this.words.length > 0) {
          this.showWord(this.words[0]);
        }
        this.updateProgress();
      }
      
      updateProgress() {
        const progress = this.words.length > 0 ? (this.currentIndex / this.words.length) * 100 : 0;
        this.progressFill.style.width = `${Math.min(100, progress)}%`;
        this.progressText.textContent = `${Math.min(this.currentIndex, this.words.length)} / ${this.words.length} words`;
      }
    }
    
    // Register service worker for offline support
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(() => {});
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      new RSVPReader();
    });
  </script>
</body>
</html>
